<!DOCTYPE html>
<html lang="ko">
<div th:replace="import::head"></div>
<body class="flex flex-col items-center justify-start h-screen">
<div th:replace="header::div"></div>
<!--  ì±„íŒ… ë°•ìŠ¤  -->
<div class="flex flex-col h-[1000px] w-7/12 w-[900px] mt-6" id="app">

    <div class="text-3xl my-3 font-semibold"
         th:if="${username != bidDetails.sellerName}">ìž…ì°°í•˜ê¸°</div>

    <!-- ìž…ì°°í•˜ê¸° -->
    <form id="bidForm" class="flex justify-between" th:if="${username != bidDetails.sellerName}">
        <div class="flex items-start justify-center ">
            <!--       ì•Œë¦¼ ë©”ì‹œì§€       -->
            <div class="flex items-baseline ">
                <input type="hidden" id="itemId" name="itemId" th:value="${itemId}">
                <input type="text" id="itemPrice" name="itemPrice" class="w-80 font-semibold" placeholder="ìž…ì°°í•  ê°€ê²©ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.(ë‹¨ìœ„ 100ì›)"></input>
            </div>
        </div>
        <!--      ì‚¬ì§„      -->
        <div class="inline-block  text-indigo-400 font-bold ml-auto truncate items-center justify-center">
            <button type="button" id="submit" class="flex hover:bg-zinc-200 items-center mr-1">ìž…ì°°í•˜ê¸°</button>
        </div>
    </form>

    <div class="border border-inherit mb-5" th:if="${username != bidDetails.sellerName}"></div>

    <div class="text-3xl my-2 font-semibold">ìž…ì°° ë‚´ì—­</div>

    <!--     ìƒë‹¨ ì•„ì´í…œ       -->
    <div class="flex m-2">
        <div class="w-[100px] h-[70px] truncate rounded-lg">
            <img src="http://localhost:8080/api/v1/image/item/banana.jpg">
            <!-- <img th:src="'http://localhost:8080/api/v1/image/item/' + ${bidDetails.imgName}"> -->
        </div>
        <div class="flex flex-col justify-center ml-2">
            <div th:text="${bidDetails.getItemTitle()}"> </div>
            <div class="text-sm text-indigo-400" th:text=" 'í¬ë§ê¸ˆì•¡' + ${bidDetails.getDesiredPrice()} +'ì›' "> </div>
        </div>

        <div class="flex flex-col justify-center ml-2 ml-auto">
            <div class="text-indigo-400 font-bold" th:if="${bidDetails.maxPrice != null}" th:text=" 'ìµœê³ ê°€ â‚©' + ${bidDetails.getMaxPrice()}"> </div>
            <div class="text-indigo-400 font-bold" th:if="${bidDetails.avgPrice != null}" th:text=" 'í‰ê· ê°€ â‚©' + ${bidDetails.getAvgPrice()}"> </div>
            <div class="text-indigo-400 font-bold" th:if="${bidDetails.minPrice != null}" th:text=" 'ìµœì €ê°€ â‚©' + ${bidDetails.getMinPrice()}"> </div>
        </div>
    </div>

    <!--   ê°€ë¡œì„    -->
    <div class="border border-inherit mt-4"></div>
    <div class="flex justify-start h-5/6 w-full">
        <!--   ì„¸ë¡œì„  ì‹œìž‘ì„     -->
        <div class="border border-inherit h-full"></div>
        <!--   ì±„íŒ…ë°©     -->
        <div class="flex flex-col justify-between w-full overflow-y-scroll">


            <div class="flex flex-col">
                <!--     ì±„íŒ…ë°© ì•„ì´í…œ     -->
                <button class="flex px-3 py-5 hover:bg-zinc-200 items-center"
                        th:each ="bid: ${bids}">
                    <!--      ì´ëª¨í‹°ì½˜      -->
                    <div class="inline-block text-4xl mx-2">ðŸ™Œ</div>
                    <!--      ë©”ì‹œì§€, ì‹œê°„      -->
                    <div class="flex flex-col items-start ml-2">
                        <!--       ì•Œë¦¼ ë©”ì‹œì§€       -->
                        <div class="flex items-baseline">
                            <div class="font-semibold" th:text="${bid.getBidderName()} + 'ë‹˜ì´'  + ${bid.getBidPrice()} + 'ì›ì„ ì œì‹œí•˜ì˜€ìŠµë‹ˆë‹¤.'">  </div>
                        </div>
                        <!--       ì•Œë¦¼ ì‹œê°„       -->
                        <div class="truncate text-sm text-zinc-700" th:text="${bid.createdDate}"></div>
                    </div>
                </button>
            </div>
        </div>

        <!--   ì„¸ë¡œì„  ì±„íŒ…ë°© ì˜¤ë¥¸ìª½     -->
        <div class="border border-inherit"></div>


        <!--   ì„¸ë¡œì„  ì±„íŒ…ì°½ ì˜¤ë¥¸ìª½     -->
        <div class="border border-inherit"></div>
    </div>
    <div class="border border-inherit"></div>
</div>
</body>
<script>
    const numberInput = document.getElementById('myNumberInput');
    numberInput.addEventListener('focus', () => {
        numberInput.blur();
    });
</script>

<script>
    $(function(){
        $('#submit').on("click",function () {
            var itemId = parseInt($('#itemId').val());
            var itemPrice = $('#itemPrice').val()
            var formData = {
                itemId: itemId,
                itemPrice: itemPrice
            };
            var jsonData = JSON.stringify(formData);
            var url = "/bid/list?itemId=" + itemId;

            axios.get('/api/v1/bid-ids', {
                auth: {
                    username: localStorage.getItem('username'),
                    password: ''
                }
            }).then(response => {
                const itemIds = response.data;
                if (!itemIds.includes(itemId)) {
                    connect(itemId);
                }
            }).catch(error => console.log(error));

            $.ajax({
                type: "post",
                url: "/bid",
                data: jsonData,
                contentType: "application/json",
                success: function (data) {
                    alert("ìž…ì°°ì„ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤!");
                    window.location.href = url;
                },
                error: function (request, status, error) {
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);

                }
            });
        });
    });

    connect = (itemId) => {
        socket = new SockJS("/ws-stomp");
        ws = Stomp.over(socket);
        let reconnect = 0;

        ws.connect({}, (frame) => {
            ws.subscribe("/sub/notification/item/" + itemId,
                (message) => {
                    const senderName = message.body;
                    // if (localStorage.getItem('username') === senderName) {
                        console.log("icon í‘œì‹œ");
                    // }
                });
        }, (error) => {});
    }
</script>

</html>