<div th:replace="import::head"></div>
<body class="flex flex-col items-center justify-start h-screen">
<div th:replace="header::div"></div>
<!--  Ï±ÑÌåÖ Î∞ïÏä§  -->
<div class="flex flex-col  h-[750px] w-7/12 w-[700px]" id="chat">
    <div class="text-3xl mt-5 font-semibold">Ï±ÑÌåÖ</div>
    <!--   Í∞ÄÎ°úÏÑ†   -->
    <div class="border border-inherit mt-4"></div>
    <div class="flex justify-start h-5/6 w-full">
        <!--   ÏÑ∏Î°úÏÑ† ÏãúÏûëÏÑ†    -->
        <div class="border border-inherit h-full"></div>
        <!--   Ï±ÑÌåÖÎ∞©     -->
        <div class="flex flex-col w-[200px] justify-between">
            <div class="flex flex-col overflow-y-auto">
                <!--     Ï±ÑÌåÖÎ∞© ÏïÑÏù¥ÌÖú     -->
                <button class="flex p-3 hover:bg-zinc-200 justify-start items-center"
                        :class="{'bg-zinc-200': chatRoom.checked}"
                        v-for="chatRoom in chatRooms" :key="chatRoom.chatRoomId"
                        v-on:click="connectChatRoom(chatRoom.chatRoomId)">
                    <!--      ÏïÑÎ∞îÌÉÄ      -->
                    <img src="/image/profile.png" class="w-[40px] h-[40px] mr-1">
                    <!--      ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ, ÏãúÍ∞Ñ, ÎßàÏßÄÎßâ Ï±ÑÌåÖ      -->
                    <div class="flex flex-col items-start justify-start ml-2 truncate">
                        <!--       ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ, ÏãúÍ∞Ñ       -->
                        <div class="flex items-baseline ">
                            <div class="font-semibold text-lg truncate">{{ chatRoom.toUserName }}</div>
                            <!--                            <div class="ml-2 text-xs text-zinc-500">{{ chatRoom.itemTitle }}</div>-->
                        </div>
                        <!--       ÎßàÏßÄÎßâ Ï±ÑÌåÖ       -->
                        <div class="flex justify-start truncate text-sm text-zinc-700 w-8/12"> {{ chatRoom.itemTitle }}</div>
                    </div>
                </button>
            </div>
        </div>

        <!--   ÏÑ∏Î°úÏÑ† Ï±ÑÌåÖÎ∞© Ïò§Î•∏Ï™Ω     -->
        <div class="border border-inherit"></div>

        <div v-if="chatRooms.length === 0">
            <div class="flex items-center justify-center w-[500px] text-xl mt-[100px]"> ÏïÑÏßÅ Ï±ÑÌåÖÎ∞©Ïù¥ ÏóÜÎÑ§Ïöî!üò¥</div>
        </div>

        <div v-else-if="chatRoomId === -1">
            <div class="flex items-center justify-center w-[500px] text-xl mt-[100px]"> Ï±ÑÌåÖÎ∞©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
        </div>

        <div v-else class="flex flex-col w-[500px]">
            <!--     ÏÉÅÎã® ÏïÑÏù¥ÌÖú       -->
            <div class="flex flex-col" v-on:click="clickItem(itemId)" >
                <div class="flex m-2">
                    <div class="w-[90px] h-[60px] truncate rounded-lg">
                        <img :src="itemImageUrl" class="object-cover h-full w-full">
                    </div>
                    <div class="flex flex-col justify-center ml-2">
                        <div> {{ itemTitle }}</div>
                        <div class="text-sm text-indigo-400">{{ itemPrice }}</div>
                    </div>
                </div>
                <div class="border border-inherit"></div>
            </div>

            <!--    Ï±ÑÌåÖ ÎÇ¥Ïö©    -->
            <div class="flex flex-col-reverse justify-start w-full h-[600px] overflow-auto">
                <!--     Ï±ÑÌåÖ ÏûÖÎ†• input     -->
                <div class="mb-3 mt-5">
                    <div class="flex justify-between">
                        <label class="w-full ml-3">
                            <input type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" class="w-full" v-model="message"
                                   @keyup.enter="sendMessage"/>
                        </label>
                        <button class="min-w-[8%]" @click="sendMessage">
                            <img src="/image/submit.png" class="w-[25px] h-[25px]">
                        </button>
                    </div>
                </div>
                <!--    Ï±ÑÌåÖ ÎÇ¥Ïó≠        -->
                <div class="my-1" v-for="(message, i) in messages" v-bind:key="i">
                    <div v-if="message.sender === username">
                        <div class="flex justify-end px-5">
                            <div class="border border-blue-100 py-1 px-3 bg-blue-100 rounded-md">
                                {{ message.message }}
                            </div>
                        </div>
                    </div>
                    <div v-else>
                        <div class="flex justify-start px-5">
                            <div class="border border-zinc-100 py-1 px-3 bg-zinc-100 rounded-md">
                                {{ message.message }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--   ÏÑ∏Î°úÏÑ† Ï±ÑÌåÖÏ∞Ω Ïò§Î•∏Ï™Ω     -->
        <div class="border border-inherit"></div>
    </div>
    <div class="border border-inherit"></div>
    <input type="hidden" id="chatRoomId" th:value="${ chatRoomId }">
</div>
</body>

<script>
    let socket;
    let ws;
    new Vue({
        el: '#chat',
        data: {
            chatRooms: [],
            messages: [],
            belongedRooms: [],
            chatRoomId: -1,
            message: "",
            username: "",
            toUserId: -1,
            itemPrice: -1,
            itemTitle: '',
            itemImageUrl: '',
            itemId: -1
        },
        created() {
            const chatRoomId = document.getElementById('chatRoomId').value;
            this.username = localStorage.getItem('username');

            axios.get('/api/v1/chat-room/list', {
                auth: {
                    username: this.username,
                    password: ''
                }
            })
                .then(response => {
                    const chatRooms = response.data;
                    chatRooms.forEach(chatRoom => {
                        this.chatRooms.push({
                            chatRoomId: chatRoom.chatRoomId,
                            toUserId: chatRoom.toUserId,
                            toUserName: chatRoom.toUserName,
                            itemTitle: chatRoom.itemTitle
                        })
                    });

                    if (chatRoomId !== '') {
                        this.connectChatRoom(parseInt(chatRoomId))
                    }
                });
        },

        methods: {
            connectChatRoom(chatRoomId) {
                this.updateCheck(chatRoomId);
                this.chatRoomId = chatRoomId;
                this.updateChatRoomDetail(chatRoomId);
                this.getChatHistory(chatRoomId);
                this.connectSocket(chatRoomId);
            },
            sendMessage() {
                if (this.message === "") return;
                ws.send("/pub/chat/message", {},
                    JSON.stringify({
                        chatRoomId: this.chatRoomId,
                        username: this.username,
                        message: this.message
                    }));
                this.message = '';
                ws.send("/pub/chat/notification", {},
                    JSON.stringify({
                        toUserId: this.toUserId,
                        toUsername: this.username
                    }));
            },
            updateCheck(chatRoomId) {
                this.chatRooms.forEach(room => {
                    if (room.chatRoomId === this.chatRoomId) {
                        room.checked = false;
                    } else if (room.chatRoomId === chatRoomId) {
                        room.checked = true;
                    }
                })
            },
            connectSocket(chatRoomId) {
                if (this.belongedRooms.includes(chatRoomId)) return;

                this.belongedRooms.push(chatRoomId);

                socket = new SockJS("/ws-stomp");
                ws = Stomp.over(socket);

                ws.connect({}, (frame) => {
                    ws.subscribe("/sub/chat-room/" + chatRoomId,
                        (message) => {
                            let recv = JSON.parse(message.body);
                            this.messages.unshift(recv);
                        });
                }, (error) => {
                    console.log(error);
                });
            },
            updateChatRoomDetail(chatRoomId) {
                axios.get('/api/v1/chat-detail/' + chatRoomId, {
                    auth: {
                        username: this.username,
                        password: ''
                    }
                }).then(response => {
                    const data = response.data;
                    this.toUserId = data.toUserId;
                    this.itemPrice = data.price;
                    this.itemImageUrl = 'http://localhost:8080/api/v1/image/item/' + data.itemImageName;
                    this.itemTitle = data.itemTitle;
                    this.itemId = data.itemId;
                }).catch(error => {
                    console.log(error);
                })
            },
            getChatHistory(chatRoomId) {
                axios.get('/api/v1/chat/list/' + chatRoomId, {
                    auth: {
                        username: this.username,
                        password: ''
                    }
                }).then(response => {
                    this.messages = response.data;
                }).catch(error => {
                    console.log(error);
                })
            },
            clickItem(itemId) {
                window.location.href = 'http://localhost:8080/item/' + itemId;
            },
        }
    });
</script>
