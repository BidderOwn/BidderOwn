<!DOCTYPE html>
<html lang="ko">
<div th:replace="import::head"></div>

<body>
<div id="app">
    <div th:replace="header::div"></div>
    <div class="flex flex-col items-center mt-10">
        <!--    <div clss="mr-5">{{ username }}</div>-->
        <!-- 선택 박스   -->
        <div class="w-[1230px] text-end mr-[80px] mb-3">
            <select class="bg-gray-200 rounded-sm px-1 py-1" :value="selected" @change="setOrder($event)">
                <option v-for="(item, index) in selectList"
                        :key="index"
                        :value="item.value">
                    {{ item.name }}
                </option>
            </select>
        </div>

        <!-- 그리드 -->
        <div class="grid grid-cols-3 place-items-center w-[1200px] snap-y">
            <div v-for="item in items" v-bind:key="item.id">
                <!--  아이템 하나  -->
                <div class="flex flex-col w-[350px] min-w-[350px] h-[300px] mb-[30px] cursor-pointer"
                     v-on:click="clickItem(item.id)">
                    <!--   이미지   -->
                    <div class="w-[350px] h-[230px] truncate rounded-lg">
                        <img class="object-cover h-full w-full" :src="item.thumbnailImageUrl" width="350" height="212">
                    </div>
                    <!--   제목   -->
                    <div class="flex justify-start items-center mt-1">
                        <div class="flex items-start">
                            <div v-if="item.itemStatus === '경매종료' || item.itemStatus === '판매완료'" class="text-xl font-bold text-gray-600">{{ item.title }}</div>
                            <div v-else class="text-xl font-bold">{{ item.title }}</div>
                            <div v-if="item.itemStatus === '경매종료' || item.itemStatus === '판매완료'" class="text-sm text-gray-600 ml-1 pt-[2px]">경매종료</div>
                        </div>
                        <div class="flex ml-auto">
                            <!--  좋아요 카운트  -->
                            <span class="flex mr-2">
                                <img v-if="!item.likeStatus" src="https://kr.object.ncloudstorage.com/s3bucket/empty_heart.png" class="w-[20px] h-[20px]">
                                <img v-else src="https://kr.object.ncloudstorage.com/s3bucket/full_heart.png" class="w-[20px] h-[20px]">
                                <span class="text-sm text-gray-600">{{ item.heartsCount }}</span>
                            </span>
                            <!--  비드 카운트  -->
                            <span class="flex mr-2">
                                <img src="https://kr.object.ncloudstorage.com/s3bucket/person.png" class="w-[20px] h-[20px]">
                                <span class="text-sm text-gray-600">{{ item.bidCount }}</span>
                            </span>
                            <!--  댓글 카운트  -->
                            <span class="flex items-center">
                                <img src="https://kr.object.ncloudstorage.com/s3bucket/comment.png" class="w-[18px] h-[18px] mr-1">
                                <span class="text-sm text-gray-600">{{ item.commentsCount }}</span>
                            </span>
                        </div>
                    </div>

                    <div class="text-sm text-indigo-400">₩{{ item.minimumPrice }}</div>
                    <div class="flex">
                        <span class="text-sm text-gray-600" v-if="isPriceShow(item.minPrice)">
                            최저가 ₩{{ item.minPrice }} ~ &nbsp
                        </span>
                        <span class="text-sm text-gray-600"  v-if="isPriceShow(item.minPrice) === false">최저가&nbsp₩&nbsp~&nbsp</span>

                        <span class="text-sm text-gray-600" v-if="isPriceShow(item.maxPrice)">
                            최고가 ₩{{ item.maxPrice }}
                        </span>
                        <span class="text-sm text-gray-600"  v-if="isPriceShow(item.minPrice) === false">최고가&nbsp₩&nbsp</span>
                    </div>
                    <div class="text-sm text-gray-600" v-if="item.itemStatus === 'BIDDING'">{{ item.expireAt }}</div>
                    <div v-else>&nbsp</div>
                </div>
            </div>
        </div>
        <input type="hidden" id="username" th:value="${username}">
        <input type="hidden" id="searchText" th:value="${searchText}">
        <button v-on:click="addItem" class="w-[70px] h-[70px] mb-[35px] mr-[50px] fixed bottom-0 right-0">
            <img src="https://kr.object.ncloudstorage.com/s3bucket/add_item.png">
        </button>
        <button class="mb-10" v-on:click="addData">
            더 불러오기
        </button>

    </div>
</div>
</body>
<script>
    new Vue({
        el: '#app',
        data: {
            username: '',
            selectList: [
                {name: "최신순", value: '1'},
                {name: "인기순", value: '2'},
                {name: "종료임박순", value: '3'}
            ],
            selected: '',
            items: [],
            page: 0,
            size: 9,
            searchText: '',
            prefix: '/api/v1/item/list',
            likes: [],
        },
        created() {
            this.username = document.getElementById('username').value;
            this.searchText = document.getElementById('searchText').value;
            localStorage.setItem("username", this.username);
            this.selected = this.selectList[0].value;
            this.likes = this.getLikeIdList();
            this.addData();
        },
        methods: {
            addData() {
                axios.get(this.prefix + this.getQuery() + this.getLastItemId()).then(response => {
                    response.data.forEach(item => {
                        this.items.push(
                            {
                                id: item.id,
                                title: item.title,
                                bidCount: item.bidCount,
                                commentsCount: item.commentsCount,
                                heartsCount: item.heartsCount,
                                minimumPrice: item.minimumPrice,
                                minPrice: item.minPrice,
                                maxPrice: item.maxPrice,
                                expireAt: this.getTimeAgo(item.expireAt),
                                itemStatus : item.itemStatus,
                                thumbnailImageName: item.thumbnailImageName,
                                thumbnailImageUrl: 'https://kr.object.ncloudstorage.com/s3bucket/' + item.thumbnailImageName,
                                likeStatus: this.checkLikeId(item.id),
                            },
                        )
                    })
                }).catch(error => {
                    console.log(error);
                })
                this.page++;
            },
            setOrder(event) {
                this.page = 0;
                this.items = [];
                this.selected = event.target.value;
                this.addData();
            },
            clickItem(itemId) {
                window.location.href = window.location.protocol + "//" + window.location.host + "/item/" + itemId;
            },
            getTimeAgo(date) {
                const currentDate = new Date();
                const timeDiff =  new Date(date) - currentDate;

                const minuteDiff = Math.floor(timeDiff / 1000 / 60);
                const hourDiff = Math.floor(timeDiff / 1000 / 60 / 60);
                const dayDiff = Math.floor(timeDiff / 1000 / 60 / 60 / 24);

                if (minuteDiff < 1) {
                    return "1분 안에 종료";
                } else if (hourDiff < 1) {
                    return `${minuteDiff}분 남음`;
                } else if (dayDiff < 1) {
                    return `${hourDiff}시간 남음`;
                } else {
                    return `${dayDiff}일 남음`;
                }
            },
            isPriceShow(price) {
                return price !== null;
            },
            addItem() {
                window.location.href = window.location.protocol + "//" + window.location.host + "/item";
            },
            getQuery() {
                let query = '';
                if (this.selected !== '' || this.searchText !== '') {
                    query += '?';
                }
                if (this.selected !== '') {
                    query += "s=" + this.selected;
                }

                if (this.searchText !== '') {
                    if (this.selected !== '') {
                        query += '&';
                    }
                    query += 'q=' + this.searchText;
                }
                return query;
            },
            getLastItemId() {
                let query = '';
                if (this.items.length > 0 && this.selected === '1') {
                    query += "&id=" + this.items[this.items.length - 1].id;
                } else if (this.selected !== '1') {
                    query += "&page=" + this.page
                }
                query += "&size=" + this.size;
                return query;
            },
            getLikeIdList() {
                axios.get('/api/v1/item/home/likes')
                    .then(response => {
                        this.likes = response.data;
                    }).catch(error => {
                    console.log(error);
                })
            },
            checkLikeId(itemId) {
                return this.likes.includes(itemId);
            }
        }
    })
</script>
</html>