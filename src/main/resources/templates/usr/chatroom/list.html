<div th:replace="import::head"></div>
<body>
<div th:replace="header::div"></div>
<!--  Ï±ÑÌåÖ Î∞ïÏä§  -->
<div class="flex flex-col mt-20 items-center">
    <div class="flex flex-col h-[89vh] w-[600px]" id="chat">
        <!--   Í∞ÄÎ°úÏÑ†   -->
        <div class="border-[0.5px] border-inherit mt-4"></div>
        <div class="flex justify-start h-full w-full">
            <!--   ÏÑ∏Î°úÏÑ† ÏãúÏûëÏÑ†    -->
            <div class="border-[0.5px] border-inherit h-full"></div>
            <!--   Ï±ÑÌåÖÎ∞©     -->
            <div class="flex flex-col w-[200px] justify-between">
                <div class="flex flex-col overflow-y-auto">
                    <!--     Ï±ÑÌåÖÎ∞© ÏïÑÏù¥ÌÖú     -->
                    <button class="flex px-3 py-2 hover:bg-zinc-100 justify-start items-center w-full"
                            :class="{'bg-zinc-200': chatRoom.checked}"
                            v-for="chatRoom in chatRooms" :key="chatRoom.chatRoomId"
                            @click="connectChatRoom(chatRoom.chatRoomId)">
                        <!--      ÏïÑÎ∞îÌÉÄ      -->
                        <img src="https://kr.object.ncloudstorage.com/s3bucket/profile.png"
                             class="w-[35px] h-[35px] mr-1">
                        <!--      ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ, ÏïÑÏù¥ÌÖú Ï†úÎ™©      -->
                        <div class="flex flex-col items-start justify-start ml-2 truncate w-[100px]">
                            <!--       ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ, ÏãúÍ∞Ñ       -->
                            <div class="flex items-baseline ">
                                <div class="font-semibold text-[16px] truncate">{{ chatRoom.toUserName }}</div>
                            </div>
                            <!--       ÎßàÏßÄÎßâ Ï±ÑÌåÖ       -->
                            <div class="flex justify-start truncate text-[14px] text-zinc-600"> {{ chatRoom.itemTitle }}
                            </div>
                        </div>
                    </button>
                </div>
            </div>
            <!--   ÏÑ∏Î°úÏÑ† Ï±ÑÌåÖÎ∞© Ïò§Î•∏Ï™Ω     -->
            <div class="border-[0.5px] border-inherit"></div>
            <div v-if="chatRooms.length === 0">
                <div class="flex items-center justify-center text-[14px] w-[400px] mt-[100px]"> ÏïÑÏßÅ Ï±ÑÌåÖÎ∞©Ïù¥ ÏóÜÎÑ§Ïöî!üò¥</div>
            </div>

            <div v-else-if="chatRoomId === -1">
                <div class="flex items-center justify-center text-[14px] w-[400px] mt-[100px]"> Ï±ÑÌåÖÎ∞©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
            </div>
            <div v-else class="flex flex-col w-[400px] justify-between">
                <!--     ÏÉÅÎã® ÏïÑÏù¥ÌÖú       -->
                <div class="flex flex-col" @click="clickItem(itemId)">
                    <div class="flex m-2">
                        <div class="w-[80px] h-[55px] truncate rounded-lg">
                            <img :src="itemImageUrl" class="object-cover h-full w-full">
                        </div>
                        <div class="flex flex-col justify-center ml-2">
                            <div class="font-semibold text-[16px]"> {{ itemTitle }}</div>
                            <div class="text-[14px] text-zinc-600">{{ itemPrice }}Ïõê</div>
                        </div>
                    </div>
                    <div class="border-[0.5px] border-inherit"></div>
                </div>

                <!--    Ï±ÑÌåÖ ÎÇ¥Ïö©    -->
                <div class="flex flex-col-reverse justify-start w-full">
                    <!--     Ï±ÑÌåÖ ÏûÖÎ†• input     -->
                    <div class="mb-3 mt-5">
                        <div class="flex justify-between">
                            <label class="w-full ml-3">
                                <input type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" class="w-11/12" v-model="message"
                                       @keyup.enter="sendMessage"/>
                            </label>
                            <button class="min-w-[8%]" @click="sendMessage">
                                <img src="https://kr.object.ncloudstorage.com/s3bucket/submit.png"
                                     class="w-[25px] h-[25px]">
                            </button>
                        </div>
                    </div>
                    <!--    Ï±ÑÌåÖ ÎÇ¥Ïó≠      -->

                    <div class="flex flex-col-reverse overflow-auto h-[71vh]">
                        <div class="my-1" v-for="(message, i) in messages" :key="i">
                            <div v-if="message.sender === username">
                                <div class="flex justify-end px-5">
                                    <div class="border border-blue-100 py-1 px-3 bg-blue-100 rounded-md">
                                        {{ message.message }}
                                    </div>
                                </div>
                            </div>
                            <div v-else>
                                <div class="flex justify-start px-5">
                                    <div class="border border-zinc-100 py-1 px-3 bg-zinc-100 rounded-md">
                                        {{ message.message }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--   ÏÑ∏Î°úÏÑ† Ï±ÑÌåÖÏ∞Ω Ïò§Î•∏Ï™Ω     -->
            <div class="border-[0.5px] border-inherit"></div>
        </div>
        <div class="border-[0.5px] border-inherit"></div>
        <input type="hidden" id="itemId" th:value="${ itemId }">
        <input type="hidden" id="buyerName" th:value="${ buyerName }">
    </div>
</div>
</body>

<script>
    let socket;
    let ws;
    new Vue({
        el: '#chat',
        data: {
            chatRooms: [],
            messages: [],
            belongedRooms: [],
            chatRoomId: -1,
            initChatRoomId: -1,
            message: "",
            username: "",
            toUserId: -1,
            itemPrice: -1,
            itemTitle: '',
            itemImageUrl: '',
            itemId: -1
        },
        created() {
            const itemId = document.getElementById('itemId').value;
            const buyerName = document.getElementById('buyerName').value;
            this.username = localStorage.getItem('username');
            /**
             * Ï±ÑÌåÖÎ∞© Î¶¨Ïä§Ìä∏ ÌéòÏù¥ÏßÄÏóê Ïò§Î©¥ Í∏∞Î≥∏Ï†ÅÏúºÎ°ú handleChatÎ©îÏÑúÎìúÎ•º ÌÜµÌï¥ Ï∞∏Ïó¨Ìï† Ï±ÑÌåÖÎ∞©Ïùò ÏïÑÏù¥ÎîîÎ•º ÎÑòÍ≤®Î∞õÏäµÎãàÎã§.
             * Ïù∏ÏûêÍ∞í ÏóÜÏù¥ ÎÑòÏñ¥ÏôîÏùÑ ÎïåÎäî -1ÏùÑ ÎÑòÍ≤®Î∞õÏäµÎãàÎã§.
             * ÎπÑÎèôÍ∏∞ Ï≤òÎ¶¨Ïùò ÏàúÏÑúÎ•º Î≥¥Ïû•ÌïòÍ∏∞ ÏúÑÌï¥ Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± or Ï°∞Ìöå -> Ï±ÑÌåÖÎ∞© Î™©Î°ù Ï°∞Ìöå -> Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞Ïóê Ï≤¥ÌåÖÎ∞© Ï∂îÍ∞Ä
             */
            axios.post('/api/v1/chat-room', {
                buyerName: buyerName,
                itemId: itemId
            })
                .then(response => {
                    this.initChatRoomId = response.data;
                    return axios.get('/api/v1/chat-room/list');
                })
                .then(response => {
                    response.data.forEach(chatRoom => {
                        this.chatRooms.unshift({
                            chatRoomId: chatRoom.chatRoomId,
                            toUserId: chatRoom.toUserId,
                            toUserName: chatRoom.toUserName,
                            itemTitle: chatRoom.itemTitle
                        });
                    });
                    if (this.initChatRoomId !== -1) {
                        this.connectChatRoom(parseInt(this.initChatRoomId));
                    }
                })
                .catch(error => console.log(error));
        },
        methods: {
            connectChatRoom(chatRoomId) {
                this.updateCheck(chatRoomId);
                this.chatRoomId = chatRoomId;
                this.updateChatRoomDetail(chatRoomId);
                this.getChatHistory(chatRoomId);
                this.connectSocket(chatRoomId);
            },
            sendMessage() {
                if (this.message === "") return;

                // Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ
                ws.send("/pub/chat/message", {},
                    JSON.stringify({
                        chatRoomId: this.chatRoomId,
                        username: this.username,
                        message: this.message
                    }));
                this.message = '';

                // Ï±ÑÌåÖ ÏïÑÏù¥ÏΩò ÏïåÎ¶º ÌëúÏãú
                ws.send("/pub/chat/notification", {},
                    JSON.stringify({
                        toUserId: this.toUserId,
                        toUsername: this.username
                    }));
            },
            updateCheck(chatRoomId) {
                this.chatRooms.forEach(room => {
                    if (room.chatRoomId === this.chatRoomId) {
                        room.checked = false;
                    } else if (room.chatRoomId === chatRoomId) {
                        room.checked = true;
                    }
                })
            },
            connectSocket(chatRoomId) {
                if (this.belongedRooms.includes(chatRoomId)) return;

                this.belongedRooms.push(chatRoomId);

                socket = new SockJS("/ws-stomp");
                ws = Stomp.over(socket);

                ws.connect({}, (frame) => {
                    ws.subscribe("/sub/chat-room/" + chatRoomId,
                        (message) => {
                            let recv = JSON.parse(message.body);
                            this.messages.unshift(recv);
                        });
                }, (error) => {
                    console.log(error);
                });
            },
            updateChatRoomDetail(chatRoomId) {
                axios.get('/api/v1/chat-room/detail/' + chatRoomId, {}).then(response => {
                    const data = response.data;
                    this.toUserId = data.toUserId;
                    this.itemPrice = data.price;
                    this.itemImageUrl = 'https://kr.object.ncloudstorage.com/s3bucket/' + data.itemImageName;
                    this.itemTitle = data.itemTitle;
                    this.itemId = data.itemId;
                }).catch(error => {
                    console.log(error);
                })
            },
            getChatHistory(chatRoomId) {
                axios.get('/api/v1/chat/list/' + chatRoomId)
                    .then(response => {
                        this.messages = response.data;
                    }).catch(error => {
                    console.log(error);
                })
            },
            clickItem(itemId) {
                window.location.href = window.location.protocol + "//" + window.location.host + "/item/" + itemId;
            },
        }
    });
</script>
